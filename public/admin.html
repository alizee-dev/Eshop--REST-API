<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Atelier — MAISON ÉLÈVE</title>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;1,300;1,400&family=Montserrat:wght@300;400;500&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="style.css"/>
</head>
<body>

  <nav class="navbar">
    <div class="nav-left">
      <a href="index.html" class="nav-link">Collection</a>
      <a href="admin.html" class="nav-link">Atelier</a>
    </div>
    <a href="index.html" class="brand">MAISON ÉLÈVE</a>
    <div class="nav-right">
      <a href="login.html" class="nav-link" id="signInLink">Sign In</a>
      <a href="cart.html" class="nav-link cart-link">Cart <span class="cart-count" id="cartCount">0</span></a>
    </div>
  </nav>

  <div class="page-header">
    <p class="section-label">Staff Only</p>
    <h1 class="page-title">Atelier</h1>
  </div>

  <div class="admin-gate" id="adminGate">
    <p>You must be signed in as admin or employee to access this page.</p>
    <a href="login.html" class="btn-primary" style="display:inline-block;margin-top:1.5rem;">Sign In</a>
  </div>

  <section class="admin-section" id="adminSection" style="display:none;">

    <!-- Tab navigation -->
    <div class="admin-tabs">
      <button class="admin-tab active" onclick="showTab('products')">Products</button>
      <button class="admin-tab" onclick="showTab('orders')" id="tabOrders">Orders</button>
      <button class="admin-tab" onclick="showTab('employees')" id="tabEmployees">Employees</button>
      <button class="admin-tab" onclick="showTab('contact')">Contact</button>
    </div>

    <!-- PRODUCTS TAB -->
    <div class="admin-tab-content" id="tabProducts">
      <div class="admin-panel">
        <h2 class="admin-panel-title">Add a New Piece</h2>
        <form id="addProductForm" class="admin-form">
          <div class="form-row">
            <div class="form-group">
              <label>Reference (number)</label>
              <input type="number" id="reference" required/>
            </div>
            <div class="form-group">
              <label>Name</label>
              <input type="text" id="name" required/>
            </div>
          </div>
          <div class="form-group">
            <label>Description</label>
            <input type="text" id="description" required/>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Price (€)</label>
              <input type="number" id="price" step="0.01" required/>
            </div>
            <div class="form-group">
              <label>Image URL</label>
              <input type="text" id="image" required/>
            </div>
          </div>
          <button type="submit" class="btn-primary">Add to Collection</button>
          <p class="form-msg" id="addMsg"></p>
        </form>
      </div>

      <div class="admin-panel">
        <h2 class="admin-panel-title">Manage Collection</h2>
        <div class="admin-products" id="adminProducts"></div>
      </div>
    </div>

    <!-- ORDERS TAB (admin only) -->
    <div class="admin-tab-content" id="tabOrdersContent" style="display:none;">
      <div class="admin-panel">
        <h2 class="admin-panel-title">All Orders</h2>
        <div id="ordersList" class="admin-products"></div>
      </div>
    </div>

    <!-- EMPLOYEES TAB (admin only) -->
    <div class="admin-tab-content" id="tabEmployeesContent" style="display:none;">
      <div class="admin-panel">
        <h2 class="admin-panel-title">Add an Employee</h2>
        <form id="addEmployeeForm" class="admin-form">
          <div class="form-row">
            <div class="form-group">
              <label>Name</label>
              <input type="text" id="empName" required/>
            </div>
            <div class="form-group">
              <label>Email</label>
              <input type="email" id="empEmail" required/>
            </div>
          </div>
          <div class="form-group">
            <label>Password</label>
            <input type="password" id="empPassword" required/>
          </div>
          <button type="submit" class="btn-primary">Create Employee Account</button>
          <p class="form-msg" id="empMsg"></p>
        </form>
      </div>

      <div class="admin-panel">
        <h2 class="admin-panel-title">Manage Employees</h2>
        <div id="employeesList" class="admin-products"></div>
      </div>
    </div>

    <!-- CONTACT TAB -->
    <div class="admin-tab-content" id="tabContact" style="display:none;">
      <div class="admin-panel">
        <h2 class="admin-panel-title">Send a Message</h2>
        <form id="contactForm" class="admin-form">
          <div class="form-group">
            <label>Your Email</label>
            <input type="email" id="contactEmail" required/>
          </div>
          <div class="form-group">
            <label>Subject</label>
            <input type="text" id="contactSubject" required/>
          </div>
          <div class="form-group">
            <label>Message</label>
            <input type="text" id="contactContent" required/>
          </div>
          <button type="submit" class="btn-primary">Send Message</button>
          <p class="form-msg" id="contactMsg"></p>
        </form>
      </div>
    </div>

  </section>

  <footer class="footer">
    <p class="footer-brand">MAISON ÉLÈVE</p>
    <p class="footer-note">All garments are made to measure. Allow 6–8 weeks for delivery.</p>
  </footer>

  <script src="app.js"></script>
  <script>
    const token = localStorage.getItem('token')
    const role = localStorage.getItem('role')

    if (!token || (role !== 'admin' && role !== 'employee')) {
      document.getElementById('adminGate').style.display = 'block'
    } else {
      document.getElementById('adminSection').style.display = 'block'
      document.getElementById('signInLink').textContent = 'Sign Out'
      document.getElementById('signInLink').onclick = (e) => {
        e.preventDefault()
        localStorage.removeItem('token')
        localStorage.removeItem('role')
        window.location.href = 'login.html'
      }

      // Hide admin-only tabs for employees
      if (role !== 'admin') {
        document.getElementById('tabOrders').style.display = 'none'
        document.getElementById('tabEmployees').style.display = 'none'
      }

      loadAdminProducts()
    }

    // ── Tab switching ──
    function showTab(tab) {
      document.querySelectorAll('.admin-tab-content').forEach(el => el.style.display = 'none')
      document.querySelectorAll('.admin-tab').forEach(el => el.classList.remove('active'))
      event.target.classList.add('active')

      if (tab === 'products') {
        document.getElementById('tabProducts').style.display = 'block'
      } else if (tab === 'orders') {
        document.getElementById('tabOrdersContent').style.display = 'block'
        loadOrders()
      } else if (tab === 'employees') {
        document.getElementById('tabEmployeesContent').style.display = 'block'
        loadEmployees()
      } else if (tab === 'contact') {
        document.getElementById('tabContact').style.display = 'block'
      }
    }

    // ── Products ──
    async function loadAdminProducts() {
      const res = await fetch('/products')
      const products = await res.json()
      const container = document.getElementById('adminProducts')
      container.innerHTML = ''
      products.forEach(p => {
        const row = document.createElement('div')
        row.className = 'admin-product-row'
        row.innerHTML = `
          <img src="${p.image}" alt="${p.name}" class="admin-thumb"/>
          <div class="admin-product-info">
            <span class="admin-product-name">${p.name}</span>
            <span class="admin-product-ref">Ref. ${p.reference} — €${p.price}</span>
          </div>
          <button class="btn-delete" onclick="deleteProduct(${p.reference})">Remove</button>
        `
        container.appendChild(row)
      })
    }

    async function deleteProduct(ref) {
      if (!confirm('Remove this piece from the collection?')) return
      const res = await fetch(`/products/${ref}`, {
        method: 'DELETE',
        headers: { Authorization: `Bearer ${token}` }
      })
      if (res.ok) loadAdminProducts()
      else alert('Could not delete product.')
    }

    document.getElementById('addProductForm').addEventListener('submit', async (e) => {
      e.preventDefault()
      const msg = document.getElementById('addMsg')
      const body = {
        reference: parseInt(document.getElementById('reference').value),
        name: document.getElementById('name').value,
        description: document.getElementById('description').value,
        price: parseFloat(document.getElementById('price').value),
        image: document.getElementById('image').value
      }
      const res = await fetch('/products/add-product', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },
        body: JSON.stringify(body)
      })
      if (res.ok) {
        msg.style.color = '#c9a96e'
        msg.textContent = 'Piece added successfully.'
        e.target.reset()
        loadAdminProducts()
      } else {
        const data = await res.text()
        msg.style.color = '#c0675a'
        msg.textContent = data || 'Error adding product.'
      }
    })

    // ── Orders ──
    async function loadOrders() {
      const res = await fetch('/cart/orders', {
        headers: { Authorization: `Bearer ${token}` }
      })
      const orders = await res.json()
      const container = document.getElementById('ordersList')
      container.innerHTML = ''

      if (!orders.length) {
        container.innerHTML = '<p style="color:var(--muted);font-style:italic;">No orders yet.</p>'
        return
      }

      orders.forEach(order => {
        const row = document.createElement('div')
        row.className = 'admin-product-row'
        row.style.flexDirection = 'column'
        row.style.alignItems = 'flex-start'
        row.style.gap = '0.5rem'
        row.innerHTML = `
          <div style="display:flex;justify-content:space-between;width:100%">
            <span class="admin-product-name">${order.firstname} ${order.lastname}</span>
            <span class="admin-product-ref" style="color:var(--gold)">${order.status}</span>
          </div>
          <span class="admin-product-ref">${order.email} — ${order.address}</span>
          <span class="admin-product-ref">${order.items.length} item(s) — Order ID: ${order._id}</span>
        `
        container.appendChild(row)
      })
    }

    // ── Employees ──
    async function loadEmployees() {
      const res = await fetch('/users/employee', {
        headers: { Authorization: `Bearer ${token}` }
      })
      const employees = await res.json()
      const container = document.getElementById('employeesList')
      container.innerHTML = ''

      if (!employees.length) {
        container.innerHTML = '<p style="color:var(--muted);font-style:italic;">No employees yet.</p>'
        return
      }

      employees.forEach(emp => {
        const row = document.createElement('div')
        row.className = 'admin-product-row'
        row.innerHTML = `
          <div class="admin-product-info">
            <span class="admin-product-name">${emp.name}</span>
            <span class="admin-product-ref">${emp.email} — ${emp.role}</span>
          </div>
          <button class="btn-delete" onclick="deleteEmployee('${emp.name}')">Remove</button>
        `
        container.appendChild(row)
      })
    }

    async function deleteEmployee(name) {
      if (!confirm(`Remove ${name} from the team?`)) return
      const res = await fetch('/users/employee', {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },
        body: JSON.stringify({ name })
      })
      if (res.ok) loadEmployees()
      else alert('Could not delete employee.')
    }

    document.getElementById('addEmployeeForm').addEventListener('submit', async (e) => {
      e.preventDefault()
      const msg = document.getElementById('empMsg')
      const body = {
        name: document.getElementById('empName').value,
        email: document.getElementById('empEmail').value,
        password: document.getElementById('empPassword').value
      }
      const res = await fetch('/users/employee', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },
        body: JSON.stringify(body)
      })
      const data = await res.json()
      if (res.ok) {
        msg.style.color = '#c9a96e'
        msg.textContent = 'Employee added successfully.'
        e.target.reset()
        loadEmployees()
      } else {
        msg.style.color = '#c0675a'
        msg.textContent = data.error || 'Error adding employee.'
      }
    })

    // ── Contact ──
    document.getElementById('contactForm').addEventListener('submit', async (e) => {
      e.preventDefault()
      const msg = document.getElementById('contactMsg')
      const body = {
        email: document.getElementById('contactEmail').value,
        subject: document.getElementById('contactSubject').value,
        content: document.getElementById('contactContent').value
      }
      const res = await fetch('/email', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      })
      const data = await res.json()
      if (res.ok) {
        msg.style.color = '#c9a96e'
        msg.textContent = data.message
        e.target.reset()
      } else {
        msg.style.color = '#c0675a'
        msg.textContent = 'Error sending message.'
      }
    })
  </script>
</body>
</html>